{% extends "base.html" %}
{% block title %}メッセージ{% endblock %}

{% from "_formhelpers.html" import render_field %}

{% block content %}
  <h1>Message Room</h1>
  <style>
    .chat-box {
        background-color: aliceblue;
        position: absolute;
        top: 400px;
        left: 0;
        right: 0;
        bottom: 200px;
        overflow-y: auto;
        padding: 20px;
    }

    .chat-input {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        padding: 20px;
    }
  </style>

  <div class="chat-container">
    <div class="chat-box" id="chatBox">
        {% for message in messages %}
            {% if message.from_user_id == current_user.id %}
                <div style="text-align: right;">
                    <div>
                        {% if current_user.icon %}
                            <img src="{{ url_for('static', filename=current_user.icon) }}" width="50" height="50">
                        {% else %}
                            <img src="{{ url_for('static', filename='images/default_icon.png') }}" width="50" height="50">
                        {% endif %}
                        <span>{{ current_user.name }}</span>
                    </div>
                    <div>
                        <div>
                            <p style="white-space: pre-wrap;">{{ message.message|urlize }}</p>
                        </div>
                        <div>
                            <span>{{ '既読' if message.is_read else '未読' }}</span>
                            <span>{{ message.create_at.strftime('%H:%M') }}</span>
                        </div>
                    </div>
                </div>
            {% else %}
                <div style="text-align: left;">
                    <div>
                        {% if user.icon %}
                            <img src="{{ url_for('static', filename=user.icon) }}" width="50" height="50">
                        {% else %}
                            <img src="{{ url_for('static', filename='images/default_icon.png') }}" width="50" height="50">
                        {% endif %}
                        <span>{{ user.name }}</span>
                    </div>
                    <div>
                        <div>
                            <p style="white-space: pre-wrap;">{{ message.message|urlize }}</p>
                        </div>
                        <div>
                            <span>{{ message.create_at.strftime('%H:%M') }}</span>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <div class="chat-input">
        <form>
            {{ form.csrf_token }}
            {{ form.to_user_id(value=user.id) }}
            {{ form.room(value=room) }}
            {{ render_field(form.message, cols="50", rows="5")  }}
            {{ form.submit(onclick="sendMessage()", type="button") }}
        </form>
    </div>
  </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
        const socket = io();
        const room = document.getElementById('room').value;
        const toUserId = document.getElementById('to_user_id').value;
        const messageElement = document.getElementById('message');
        const chatBox = document.getElementById('chatBox');
        const currentUserId = {{ current_user.id }}

        chatBox.scrollTop = chatBox.scrollHeight;

        socket.on('connect', function() {
            socket.emit('join', {
                user_id: toUserId,
                room: room
            });
        });

        socket.on('join', (data) => {
            console.log(data)
        })

        function sendMessage() {
            if (messageElement.value === '') {
                return;
            }

            const data = {
                message: messageElement.value,
                to_user_id: toUserId,
                room: room
            }

            socket.emit('message', data);
            messageElement.value = '';
        }

        socket.on('message', function(data) {
            const newMessageHtml = `
            <div style="text-align: ${
                data.user_id === currentUserId ? 'right' : 'left'
            };">
                <div>
                    <span>${data.user_name}</span>
                </div>
                <div>
                    <div>
                        <p style="white-space: pre-wrap;">${data.message}</p>
                    </div>
                    <div>
                        <span>${data.create_at}</span>
                    </div>
                </div>
            </div>`;

            chatBox.insertAdjacentHTML('beforeend', newMessageHtml);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        messageElement.addEventListener('keydown', function(event) {
            // Macの場合は 'metaKey' (コマンドキー), Windows/Linuxの場合は 'ctrlKey' をチェック
            if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
                sendMessage();
            }
        });
    </script>

{% endblock %}